{{template "_header" .}}
<h1>Admin</h1>

{{if .Data.Error}}
<div style="background-color: #f8d7da; color: #721c24; padding: 10px; border: 1px solid #f5c6cb; border-radius: 4px; margin-bottom: 20px;">
    <strong>Error:</strong> {{.Data.Error}}
</div>
{{end}}

{{if .Data.Success}}
<div style="background-color: #d4edda; color: #155724; padding: 10px; border: 1px solid #c3e6cb; border-radius: 4px; margin-bottom: 20px;">
    <strong>Success:</strong> {{.Data.Success}}
</div>
{{end}}

<!-- Tab Navigation -->
<div style="margin-bottom: 20px; border-bottom: 2px solid #ddd;">
    <button onclick="showAdminTab('settings')" id="admin-tab-settings" class="admin-tab-btn" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid #007bff; font-weight: bold;">
        Settings
    </button>
    <button onclick="showAdminTab('database')" id="admin-tab-database" class="admin-tab-btn" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent;">
        Database
    </button>
    <button onclick="showAdminTab('aliases')" id="admin-tab-aliases" class="admin-tab-btn" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent;">
        Aliases
    </button>
    <button onclick="showAdminTab('sedrules')" id="admin-tab-sedrules" class="admin-tab-btn" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent;">
        Sed Rules
    </button>
    <button onclick="showAdminTab('orphans')" id="admin-tab-orphans" class="admin-tab-btn" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent;">
        Orphans
    </button>
    <button onclick="showAdminTab('thumbnails')" id="admin-tab-thumbnails" class="admin-tab-btn" style="padding: 10px 20px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent;">
        Thumbnails
    </button>
</div>

<!-- Settings Tab -->
<div id="admin-content-settings">
	<div class="config-container">
    <div class="config-split">
    <h2>Settings</h2>
    <form method="post" style="max-width: 600px;">
        <input type="hidden" name="active_tab" value="settings">
        <div style="margin-bottom: 20px;">
            <label for="database_path" style="display: block; font-weight: bold; margin-bottom: 5px;">Database Path:</label>
            <input type="text" id="database_path" name="database_path" value="{{.Data.Config.DatabasePath}}" required
                   style="width: 100%; padding: 8px; font-size: 14px;"
                   placeholder="./database.db">
            <small style="color: #666;">Path to SQLite database file (requires restart if changed)</small>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="upload_dir" style="display: block; font-weight: bold; margin-bottom: 5px;">Upload Directory:</label>
            <input type="text" id="upload_dir" name="upload_dir" value="{{.Data.Config.UploadDir}}" required
                   style="width: 100%; padding: 8px; font-size: 14px;"
                   placeholder="uploads">
            <small style="color: #666;">Directory where uploaded files are stored</small>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="server_port" style="display: block; font-weight: bold; margin-bottom: 5px;">Server Port:</label>
            <input type="text" id="server_port" name="server_port" value="{{.Data.Config.ServerPort}}" required
                   style="width: 100%; padding: 8px; font-size: 14px;"
                   placeholder=":8080">
            <small style="color: #666;">Port for web server (format: :8080, requires restart if changed)</small>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="instance_name" style="display: block; font-weight: bold; margin-bottom: 5px;">Instance Name:</label>
            <input type="text" id="instance_name" name="instance_name" value="{{.Data.Config.InstanceName}}" required
                   style="width: 100%; padding: 8px; font-size: 14px;"
                   placeholder="Tagliatelle">
            <small style="color: #666;">Instance Name, used in header and title bar</small>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="gallery_size" style="display: block; font-weight: bold; margin-bottom: 5px;">Gallery Size:</label>
            <input type="text" id="gallery_size" name="gallery_size" value="{{.Data.Config.GallerySize}}" required
                   style="width: 100%; padding: 8px; font-size: 14px;"
                   placeholder="400px">
            <small style="color: #666;">Size of previews used in galleries</small>
        </div>

        <div style="margin-bottom: 20px;">
            <label for="items_per_page" style="display: block; font-weight: bold; margin-bottom: 5px;">Items per Page:</label>
            <input type="text" id="items_per_page" name="items_per_page" value="{{.Data.Config.ItemsPerPage}}" required
                   style="width: 100%; padding: 8px; font-size: 14px;"
                   placeholder="100">
            <small style="color: #666;">Items per page in galleries</small>
        </div>

        <button type="submit" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
            Save Settings
        </button>
    </form>
	</div>

    <div class="config-split">
        <h3>Current Configuration:</h3>
        <ul>
            <li><strong>Database:</strong> {{.Data.Config.DatabasePath}}</li>
            <li><strong>Upload Directory:</strong> {{.Data.Config.UploadDir}}</li>
            <li><strong>Server Port:</strong> {{.Data.Config.ServerPort}}</li>
            <li><strong>Instance Name:</strong> {{.Data.Config.InstanceName}}</li>
            <li><strong>Gallery Size:</strong> {{.Data.Config.GallerySize}}</li>
            <li><strong>Items per Page:</strong> {{.Data.Config.ItemsPerPage}}</li>
        </ul>

        <h4>Configuration File:</h4>
        <p>Settings are stored in <code>config.json</code> in the application directory.</p>
    </div>
    </div>
</div>

<!-- Database Tab -->
<div id="admin-content-database" style="display: none;">
    <h2>Database Maintenance</h2>

    <form method="post" style="margin-bottom: 20px;">
        <input type="hidden" name="active_tab" value="database">
        <input type="hidden" name="action" value="backup">
        <button type="submit" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
            Backup Database
        </button>
        <small style="color: #666; margin-left: 10px;">Creates a timestamped backup of the database file</small>
    </form>

    <form method="post">
        <input type="hidden" name="active_tab" value="database">
        <input type="hidden" name="action" value="vacuum">
        <button type="submit" style="background-color: #6f42c1; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
            Vacuum Database
        </button>
        <small style="color: #666; margin-left: 10px;">Reclaims unused space and optimizes database performance</small>
    </form>
</div>

<!-- Aliases Tab -->
<div id="admin-content-aliases" style="display: none;">
    <h2>Tag Aliases</h2>
    <p>
        Define tag aliases so that multiple tag values are treated as equivalent when searching or filtering.
        For example, if you alias "colour/blue" with "colour/navy", searching for either will show files tagged with both.
    </p>

    <div id="aliases-section" style="max-width: 800px;">
        <div id="alias-groups"></div>

        <button onclick="addAliasGroup()" style="background-color: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; margin-top: 10px;">
            + Add Alias Group
        </button>

        <form method="post" id="aliases-form" style="margin-top: 20px;">
            <input type="hidden" name="active_tab" value="aliases">
            <input type="hidden" name="action" value="save_aliases">
            <input type="hidden" name="aliases_json" id="aliases_json">
            <button type="submit" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
                Save Aliases
            </button>
        </form>
    </div>
</div>

<!-- Sed Rules Tab -->
<div id="admin-content-sedrules" style="display: none;">
	<div class="config-container">
    <div class="config-split">
    <h2>Sed Rules for Notes</h2>
    <p>
        Define sed rules that can be applied to notes in the Notes editor.
        These rules will appear as buttons in the notes interface for quick text transformations.
    </p>

    <div id="sedrules-section" style="max-width: 800px;">
        <div id="sed-rules"></div>

        <button onclick="addSedRule()" style="background-color: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; margin-top: 10px;">
            + Add Sed Rule
        </button>

        <form method="post" action="/admin" id="sedrules-form" style="margin-top: 20px;">
            <input type="hidden" name="active_tab" value="sedrules">
            <input type="hidden" name="action" value="save_sed_rules">
            <input type="hidden" name="sed_rules_json" id="sed_rules_json">
            <button type="submit" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
                Save Sed Rules
            </button>
        </form>
    </div>
    </div>

    <div class="config-split">
        <h4 style="margin-top: 0;">Example Sed Commands:</h4>
        <ul style="font-family: monospace; font-size: 13px;">
            <li><code>s?[?&]brandIds=[0-9]\+&productId=[0-9]\+??g</code> - Remove URL parameters</li>
            <li><code>s/[[:space:]]*$//</code> - Remove trailing whitespace</li>
            <li><code>s/  \+/ /g</code> - Replace multiple spaces with single space</li>
            <li><code>s/https\?:\/\/[^ ]*//g</code> - Remove URLs</li>
            <li><code>/^$/d</code> - Delete empty lines</li>
        </ul>
    </div>
    </div>
</div>

<!-- Orphans Tab -->
<div id="admin-content-orphans" style="display: none;">
    <h2>Orphaned Files</h2>

    <!-- Files on disk, not in DB -->
    <h3 style="margin-top: 24px;">Disk Orphans</h3>
    <p style="color: #666; margin-bottom: 12px;">
        These files exist in the upload directory but are not tracked in the database.
    </p>
    {{if .Data.OrphanData.Orphans}}
    <ul style="list-style-type: disc; padding-left: 20px;">
      {{range .Data.OrphanData.Orphans}}
        <li style="margin-bottom: 5px; font-family: monospace;">{{.}}</li>
      {{end}}
    </ul>
    {{else}}
    <div style="padding: 20px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 4px;">
        <strong>✓ No disk orphans found!</strong>
    </div>
    {{end}}

    <!-- Files in DB, not on disk -->
    <h3 style="margin-top: 32px;">Database Orphans</h3>
    <p style="color: #666; margin-bottom: 12px;">
        These files are tracked in the database but are missing from the upload directory.
    </p>
    {{if .Data.OrphanData.ReverseOrphans}}
    <ul style="list-style-type: disc; padding-left: 20px;">
      {{range .Data.OrphanData.ReverseOrphans}}
        <li style="margin-bottom: 5px; font-family: monospace;">{{.}}</li>
      {{end}}
    </ul>
    {{else}}
    <div style="padding: 20px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 4px;">
        <strong>✓ No database orphans found!</strong>
    </div>
    {{end}}
</div>

<!-- Thumbnails Tab -->
<div id="admin-content-thumbnails" style="display: none;">
    <h2>Thumbnail Management</h2>

    <!-- Sub-tab Navigation -->
    <div style="margin-bottom: 20px; border-bottom: 1px solid #ddd;">
        <button onclick="showThumbnailSubTab('missing')" id="thumb-subtab-missing" class="thumb-subtab-btn" style="padding: 8px 16px; border: none; background: none; cursor: pointer; border-bottom: 2px solid #007bff; font-weight: bold;">
            Missing ({{len .Data.MissingThumbnails}})
        </button>
        <button onclick="showThumbnailSubTab('regenerate')" id="thumb-subtab-regenerate" class="thumb-subtab-btn" style="padding: 8px 16px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent;">
            Regenerate
        </button>
    </div>

    <!-- Missing Thumbnails Sub-tab -->
    <div id="thumb-content-missing">
        <h3>Missing Thumbnails ({{len .Data.MissingThumbnails}})</h3>

        {{if .Data.MissingThumbnails}}
            <form method="post" action="/thumbnails/generate" style="margin-bottom: 20px;">
                <input type="hidden" name="action" value="generate_all">
                <button type="submit" onclick="return confirm('Generate thumbnails for all {{len .Data.MissingThumbnails}} videos? This may take a while.');" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
                    Generate All Missing Thumbnails
                </button>
                <small style="color: #666; margin-left: 10px;">Uses timestamp 00:00:05 for all videos</small>
            </form>

            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                {{range .Data.MissingThumbnails}}
                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #f8f9fa;">
                    <h4 style="margin-top: 0; font-size: 14px; word-break: break-word;">
                        <a href="/file/{{.ID}}" target="_blank">{{.Filename}}</a>
                    </h4>
                    <p style="color: #666; font-size: 12px; margin: 5px 0;">ID: {{.ID}}</p>

                    <video width="100%" style="max-height: 200px; background: #000; margin: 10px 0; cursor: pointer;" title="Click to capture frame">
                        <source src="/uploads/{{.EscapedFilename}}">
                    </video>

                    <form method="post" action="/thumbnails/generate" style="margin-top: 10px;">
                        <input type="hidden" name="action" value="generate_single">
                        <input type="hidden" name="file_id" value="{{.ID}}">
                        <input type="hidden" name="redirect" value="admin">

                        <div style="display: flex; gap: 5px; align-items: center; margin-bottom: 10px;">
                            <label style="font-size: 13px; white-space: nowrap;">Timestamp:</label>
                            <input type="text" name="timestamp" value="00:00:05" placeholder="00:00:05"
                                   style="flex: 1; padding: 5px; font-size: 13px; font-family: monospace;">
                        </div>

                        <button type="submit" style="background-color: #007bff; color: white; padding: 6px 12px; border: none; border-radius: 3px; font-size: 13px; cursor: pointer; width: 100%;">
                            Generate Thumbnail
                        </button>
                    </form>
                </div>
                {{end}}
            </div>
        {{else}}
            <div style="padding: 20px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 4px;">
                <strong>✓ All videos have thumbnails!</strong>
            </div>
        {{end}}
    </div>

    <!-- Regenerate Sub-tab -->
    <div id="thumb-content-regenerate" style="display: none;">
        <h3>Regenerate Thumbnail</h3>

        <div style="margin-bottom: 20px; padding: 10px; background-color: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 4px;">
            <strong>Tip:</strong> Enter a file ID to regenerate its thumbnail with a custom timestamp. You can find file IDs in the URL when viewing a file (e.g., /file/312).
        </div>

        <form method="post" action="/thumbnails/generate" style="max-width: 500px; padding: 20px; background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 5px;">
            <input type="hidden" name="action" value="generate_single">
            <input type="hidden" name="redirect" value="admin">

            <div style="margin-bottom: 20px;">
                <label for="file_id" style="display: block; font-weight: bold; margin-bottom: 5px;">File ID:</label>
                <input type="text" id="file_id" name="file_id" required
                       style="width: 100%; padding: 8px; font-size: 14px; font-family: monospace;"
                       placeholder="e.g., 312">
                <small style="color: #666;">Enter the ID of the video file</small>
            </div>

            <div style="margin-bottom: 20px;">
                <label for="timestamp" style="display: block; font-weight: bold; margin-bottom: 5px;">Timestamp:</label>
                <input type="text" id="timestamp" name="timestamp" value="00:00:05" required
                       style="width: 100%; padding: 8px; font-size: 14px; font-family: monospace;"
                       placeholder="00:00:05">
                <small style="color: #666;">Format: HH:MM:SS (e.g., 00:00:05 for 5 seconds)</small>
            </div>

            <button type="submit" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; width: 100%;">
                Generate/Regenerate Thumbnail
            </button>
        </form>
    </div>
</div>

<script>window.initialAliasGroups = {{.Data.Config.TagAliases}};</script>
<script>window.initialSedRules = {{.Data.Config.SedRules}};</script>
<script>window.activeAdminTab = "{{.Data.ActiveTab}}";</script>
<script src="/static/tag-alias.js" defer></script>
<script src="/static/sed-rules.js" defer></script>
<script src="/static/admin-tabs.js" defer></script>
<script src="/static/common.js" defer></script>

{{template "_footer"}}